const { verify } = require ("jsonwebtoken");
const { isTokenValid } = require("../api/users/user.service");

module.exports = {
    checkToken: async (req, res, next) => {
        let token = req.get("authorization");
        if (!token) {
            return res.json({
                success: 0,
                message: "Access denied! unauthorized user"
            });
        }

        token = token.slice(7);

        try {
            verify(token, "qwe1234", async (err, decoded) => {
                if (err) {
                    return res.json({
                        success: 0,
                        message: "Invalid token"
                    });
                }
                
                // Check if token is invalidated in DB
                const isValid = await isTokenValid(decoded.userId);
                if (!isValid) {
                    return res.json({
                        success: 0,
                        message: "Session expired. Please login again."
                    });
                }
                
                req.user = decoded;
                next();
            });
        } catch (err) {
            console.error("Token validation error:", err);
            return res.json({
                success: 0,
                message: "Token verification failed"
            });
        }
    }
};
